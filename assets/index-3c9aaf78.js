var I=Object.defineProperty;var V=(r,e,t)=>e in r?I(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var L=(r,e,t)=>(V(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const q="modulepreload",B=function(r){return"/pqkms-web/"+r},P={},W=function(e,t,i){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(n=>{if(n=B(n),n in P)return;P[n]=!0;const c=n.endsWith(".css"),a=c?'[rel="stylesheet"]':"";if(!!i)for(let h=s.length-1;h>=0;h--){const u=s[h];if(u.href===n&&(!c||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const o=document.createElement("link");if(o.rel=c?"stylesheet":q,c||(o.as="script",o.crossOrigin=""),o.href=n,document.head.appendChild(o),c)return new Promise((h,u)=>{o.addEventListener("load",h),o.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e()).catch(n=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=n,window.dispatchEvent(c),!c.defaultPrevented)throw n})},K=function(){const r={argon2d:0,argon2i:1,argon2id:2};function e(a){if(e._promise)return e._promise;if(e._module)return Promise.resolve(e._module);let l=t().then(o=>new Promise(h=>{o.postRun.push(()=>h(o))}));return e._promise=l,l.then(o=>(e._module=o,delete e._promise,o))}function t(){return W(()=>import("./argon2-89744aa5.js"),[]).then(a=>a.default)}function i(a,l){const o=l instanceof Uint8Array||l instanceof Array?l:s(l),h=new Uint8Array([...o,0]);return a.allocate(h,"i8",a.ALLOC_NORMAL)}function s(a){if(typeof TextEncoder=="function")return new TextEncoder().encode(a);if(typeof Buffer=="function")return Buffer.from(a);throw new Error("Don't know how to decode UTF8")}function n(a){const l=a.mem||1024;return e().then(o=>{const h=a.time||1,u=a.parallelism||1,d=i(o,a.pass),g=a.pass.length,p=i(o,a.salt),A=a.salt.length,f=o.allocate(new Array(a.hashLen||24),"i8",o.ALLOC_NORMAL),E=a.hashLen||24,R=o.allocate(new Array(512),"i8",o.ALLOC_NORMAL),F=512,H=a.type||r.argon2d,N=19;let _,S;try{S=o._argon2_hash(h,l,u,d,g,p,A,f,E,R,F,H,N)}catch(v){_=v}let U;if(S===0&&!_){let v="";const $=new Uint8Array(E);for(let b=0;b<E;b++){const D=o.HEAP8[f+b];$[b]=D,v+=("0"+(255&D).toString(16)).slice(-2)}const j=o.UTF8ToString(R);U={hash:$,hashHex:v,encoded:j}}else{try{_||(_=o.UTF8ToString(o._argon2_error_message(S)))}catch{}U={message:_,code:S}}try{o._free(d),o._free(p),o._free(f),o._free(R)}catch{}if(_)throw U;return U})}function c(a){return e().then(l=>{const o=i(l,a.pass),h=a.pass.length,u=i(l,a.encoded);let d=a.type;if(d===void 0){let f=a.encoded.split("$")[1];f&&(f=f.replace("a","A"),d=r[f]||r.argon2d)}let g,p;try{p=l._argon2_verify(u,o,h,d)}catch(f){g=f}let A;if(p||g){try{g||(g=l.UTF8ToString(l._argon2_error_message(p)))}catch{}A={message:g,code:p}}try{l._free(o),l._free(u)}catch{}if(g)throw A;return A})}return{ArgonType:r,hash:n,verify:c}}(),{ArgonType:z,hash:Y,verify:ie}=K,Z={time:2,mem:19456,parallelism:1,type:z.Argon2di},T=r=>typeof r>"u";function y(r){if(!r)throw EvalError("Assertion failed")}function J(r,e){let t=new Uint8Array(r),i=new Uint8Array(e),s=r.byteLength==e.byteLength,n=r.byteLength<e.byteLength?r.byteLength:e.byteLength;for(let c=0;c<n;c++)s&&(s=t[c]===i[c]);return s}class O extends Error{constructor(e){super(e),this.name="ValidationError"}}const k=r=>{(r.startsWith("0x")||r.startsWith("0X"))&&(r=r.substring(2)),r.length%2!==0&&(r=`0${r}`);let e=r.match(/.{1,2}/g);return e?Uint8Array.from(e.map(t=>parseInt(t,16))):Uint8Array.from([])},x=r=>new Uint8Array(r).reduce((e,t)=>e+t.toString(16).padStart(2,"0"),""),C=function(r,e="little"){r=r.replace(/-/g,"+").replace(/_/g,"/");var t=r.length%4;if(t){if(t===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");r+=new Array(5-t).join("=")}let i=new ArrayBuffer(r.length),s=new DataView(i),n=0;return e==="little"?[...atob(r)].slice().reverse().forEach(c=>s.setUint8(n++,c.codePointAt(0))):[...atob(r)].forEach(c=>s.setUint8(n++,c.codePointAt(0))),i.slice(0,n)},X=async(r,e="little")=>{y(r.algorithm.name==="RSASSA-PKCS1-v1_5");let t=await w.hsm().exportKey("jwk",r);y(!T(t.kty)&&!T(t.e)&&!T(t.n)&&(t.kty==="RSA"||t.kty==="rsa"));const i=C(t.e);return y(i.byteLength==1&&new DataView(i).getUint8(0)===3),C(t.n,e)},m=class m{constructor(){if(!globalThis.crypto||!globalThis.crypto.subtle)throw Error("Either this connection is not secure or the browser doesn't support WebCrypto")}static hsm(){return m.CRYPTO.subtle}uuid(){return m.CRYPTO.randomUUID()}async sgx_rsa_key(){const e=new Uint8Array([3]);let t=["sign","verify"],i={name:"RSASSA-PKCS1-v1_5",modulusLength:3072,publicExponent:e,hash:"SHA-256"};const s=performance.now(),n=await m.hsm().generateKey(i,!1,t),c=performance.now();return console.log("Time taken to generate RSA key: ",c-s),n}async sign_enclave(e,t){return y(t.type==="private"),y(t.algorithm.name==="RSASSA-PKCS1-v1_5"),m.hsm().sign(t.algorithm.name,t,e)}async verify_enclave(e,t,i){return y(i.algorithm.name==="RSASSA-PKCS1-v1_5"),y(i.type==="public"),m.hsm().verify(i.algorithm.name,i,t,e)}};L(m,"CRYPTO",globalThis.crypto);let w=m;class G{constructor(e){L(this,"discoveryURL");L(this,"baseURL");L(this,"urlDirectory",null);this.discoveryURL=e;const t=new URL(this.discoveryURL);this.baseURL=t.origin}async parseServerResponse(e){if(console.log(`Server returned response code: ${e.status} ${e.statusText} with headers:
 ${e.headers}`),e.ok){const t=await e.json();if(t.code>=200&&t.code<300)return t.message;throw new Error(`Server returned unexpected response with code: ${t.code} and message: ${t.message}`)}else{const t=await e.json();throw new Error(`Server error: ${t.code} => ${t.message}`)}}async fetchDirectory(){if(this.urlDirectory)return this.urlDirectory;try{const e=await fetch(this.discoveryURL,{mode:"cors"});console.log(`Server fetch returned code: ${e.status}`),e.status>=200&&e.status<300?this.urlDirectory=await e.json():this.urlDirectory={enclave_list:"/v0/admin/enclaves",register_domain:"/v0/admin/register_domain"}}catch(e){console.log(`Error getting enclave directory: ${e}`),this.urlDirectory={enclave_list:"/v0/admin/enclaves",register_domain:"/v0/admin/register_domain"}}return console.log(`Using URL directory: ${this.urlDirectory}`),this.urlDirectory}async fetchEnclaveList(){let e=await this.fetchDirectory();const t=`${this.baseURL}${e.enclave_list}`;console.log(`Attempting to fetch the list of enclaves from ${t}!`);const i=await fetch(t,{mode:"cors"});return await this.parseServerResponse(i)}async signEnclaves(e,t){const i=new w;let{privateKey:s,publicKey:n}=e.enclave_key;y(s.type==="private");let c=await X(n,"big"),a={user_info:{domain_name:e.domain_name,email_addr:e.email_addr,hashed_pass:e.hashed_pass},server_nonce:null,signer_modulus:x(c),signed_enclaves:[]};for(let l of t.enclaves){const o=k(l.tbs_data),h=k(l.sighash),u=await w.hsm().digest("SHA-256",o);let d={is_ok:!1,signature:"",enclave_name:l.enclave_name,config:l.config};if(!J(h,u))d.signature="Enclave sighash and SHA256(to-be-signed) do not match.";else{const g=await i.sign_enclave(o,s);d.is_ok=!0,d.signature=x(g),a.signed_enclaves.push(d)}}return a}async registerUser(e){let t=await this.fetchEnclaveList(),i=await this.signEnclaves(e,t),s=await this.fetchDirectory(),n=`${this.baseURL}${s.register_domain}`;console.log(`Attempting to register user at URL ${n}`),i.server_nonce=t.resp_challenge;try{let c=await fetch(n,{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),a=await this.parseServerResponse(c);return a.code>=200&&a.code<300}catch{return!1}}}function Q(r){const e=/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]$/g;if(!r.match(e))throw new O("Invalid domain prefix. Must be a valid domain component")}function M(r){if(r.length<8)throw new O("Invalid password. Must be at least 8 characters")}async function ee(r,e,t){const i=t+r+e+t,s=new TextEncoder().encode(i),n=new Uint8Array(await w.hsm().digest("SHA-256",s));return(await Y({pass:t,salt:n,...Z})).hash}async function te(r,e,t,i,s){Q(r),M(t);let n=new G(i);const c=s||await new w().sgx_rsa_key();let a=await ee(r,e,t),l={domain_name:r,email_addr:e,enclave_key:c,hashed_pass:a};const o=await n.registerUser(l);console.log("Registration ",o?"Successful":"Failed")}async function re(r){let e=new FormData(r),t=e.get("domain"),i=e.get("email"),s=e.get("password");console.log(`FormData: ${t} => ${i} => ${s}`),await te(t,i,s,"https://registrar.pqkms.dev:8443")}const ne=r=>{r.preventDefault(),r.currentTarget?re(r.currentTarget):alert("Invalid event target for registration form")},se=()=>{const r=document.querySelector("body > div > form");r?r.addEventListener("submit",ne):alert("Invalid registration test configuration")};se();
